# 使用 code-server 作为基础镜像
FROM linuxserver/code-server:4.90.3

# 使用 root 用户执行命令
USER root

# 安装必要的工具
RUN apt update && \
    apt install -y nginx curl bash git ffmpeg software-properties-common build-essential libssl-dev libbz2-dev \
    libreadline-dev libsqlite3-dev wget curl llvm libgdbm-dev libncurses5-dev \
    libncursesw5-dev xz-utils tk-dev libffi-dev zlib1g-dev python3 python3-pip && \
    apt clean && rm -rf /var/lib/apt/lists/*

# 创建工作目录
WORKDIR /home/gengshang/shiyanlou
COPY . /home/gengshang/shiyanlou/master

# 下载并执行脚本
RUN bash /home/gengshang/shiyanlou/master/publish_shiyanshi.sh /home/gengshang/shiyanlou web,gsiot,sse-server

# 删除.git目录
RUN rm -rf /home/gengshang/shiyanlou/gsiot/.git
RUN rm -rf /home/gengshang/shiyanlou/web/.git
RUN rm -rf /home/gengshang/shiyanlou/sse-server/.git

# 安装pip组件
# RUN pip install -r /home/gengshang/shiyanlou/master/requirements.txt 
RUN pip install bottle
RUN pip install watchdog
RUN pip install requests
RUN pip install python-gitlab
RUN pip install schedule
RUN pip install pytz

# 设置 /etc/sse-server 映射到宿主机
VOLUME /etc/sse-server


# 运行命令
CMD ["python","/home/gengshang/shiyanlou/sse-server/app.py"]